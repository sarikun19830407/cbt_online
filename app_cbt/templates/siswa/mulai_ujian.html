{% load dict_utils %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ujian Online</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    {% include "setting/css.html" %}
    <style>
        /* Desktop Styles */
        .question-nav {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .question-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 3px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        .timer-container {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            position: sticky;
            top: 10px;
            z-index: 1000;
        }

        .timer-container h4 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            font-family: 'Courier New', monospace;
        }

        .option-label {
            transition: background-color 0.2s;
        }

        .option-label:hover {
            background-color: #f8f9fa;
        }

        /* Mobile Styles */
        @media (max-width: 992px) {
            .mobile-accordion .accordion-button {
                padding: 1rem;
                font-weight: 500;
            }

            .mobile-accordion .accordion-button:not(.collapsed) {
                background-color: #0d6efd;
                color: white;
            }

            .mobile-accordion .accordion-body {
                padding: 1rem;
            }

            .mobile-accordion .nav-btn {
                width: 36px;
                height: 36px;
                margin: 2px;
                font-size: 0.9rem;
            }

            .timer-container {
                padding: 8px;
                margin-bottom: 10px;
            }

            .timer-container h4 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container-fluid mt-3">
        <div class="">
            {% for message in messages %}
            <ul class="list-group list-group-flush mb-2">
                <li class="btn bg-primary-subtle btn-sm fs-3 fw-bold" style="font-size: 8;" {% if message.tags %}
                    class="{{ message.tags }}" {% endif %}>{{ message }}</li>
            </ul>
            {% endfor %}
        </div>

        <div class="row g-3">
            <!-- Sidebar Desktop -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="card question-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Navigasi Soal</h5>
                    </div>
                    <div class="card-body question-nav p-3">
                        <div class="d-flex flex-wrap">
                            {% for soal in soal_list %}
                            <a href="?nomor={{ soal.Nomor }}"
                                class="btn nav-btn menu_active
                                {% if soal.id in jawaban_dict and jawaban_dict|dict_get:soal.id %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {{ soal.Nomor }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card question-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informasi Ujian</h5>
                    </div>
                    <div class="card-body p-3">
                        <div class="timer-container">
                            <h6 class="mb-1">Waktu Tersisa</h6>
                            <h4 id="timer">{{ durasi_menit|stringformat:"02d" }}:00:00</h4>
                        </div>

                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span><i class="bi bi-person me-2"></i>Nama Siswa</span>
                                <span class="fw-bold text-end">{{ user }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span><i class="bi bi-book me-2"></i>Mata Pelajaran</span>
                                <span class="fw-bold text-end">{{ seting_soal.Mapel }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span><i class="bi bi-people me-2"></i>Kelas</span>
                                <span class="fw-bold text-end">{{ user.kelas }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span><i class="bi bi-people me-2"></i>Rombel</span>
                                <span class="fw-bold text-end">{{ user.rombel }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <span><i class="bi bi-key me-2"></i>Kode Ujian</span>
                                <span class="fw-bold text-end">{{ seting_soal.Kode_Soal }}</span>
                            </li>
                        </ul>

                        
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9 col-12">
                <!-- Mobile Navigation -->
                <div class="d-lg-none mb-3 mobile-accordion">
                    <div class="accordion" id="mobileAccordion">
                        <div class="accordion-item shadow-sm mb-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#mobileNavCollapse" aria-expanded="false"
                                    aria-controls="mobileNavCollapse">
                                    <i class="bi bi-list-check me-2"></i> Navigasi Soal
                                </button>
                            </h2>
                            <div id="mobileNavCollapse" class="accordion-collapse collapse"
                                aria-labelledby="mobileNavHeader" data-bs-parent="#mobileAccordion">
                                <div class="accordion-body p-2">
                                    <div class="d-flex flex-wrap">
                                        {% for soal in soal_list %}
                                        <a href="?nomor={{ soal.Nomor }}"
                                            class="btn nav-btn menu-1
                                            {% if soal.id in jawaban_dict and jawaban_dict|dict_get:soal.id %}btn-success{% else %}btn-outline-primary{% endif %}">
                                            {{ soal.Nomor }}
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item shadow-sm">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#mobileInfoCollapse" aria-expanded="false"
                                    aria-controls="mobileInfoCollapse">
                                    <i class="bi bi-info-circle me-2"></i> Informasi Ujian
                                </button>
                            </h2>
                            <div id="mobileInfoCollapse" class="accordion-collapse collapse"
                                aria-labelledby="mobileInfoHeader" data-bs-parent="#mobileAccordion">
                                <div class="accordion-body p-2">
                                    <div class="timer-container">
                                        <h6 class="mb-1">Waktu Tersisa</h6>
                                        <h4 id="mobile-timer">{{ durasi_menit|stringformat:"02d" }}:00:00</h4>
                                    </div>

                                    <ul class="list-group list-group-flush mb-3">
                                        <li
                                            class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                                            <span><i class="bi bi-person me-2"></i>Nama Siswa</span>
                                            <span class="fw-bold">{{ user }}</span>
                                        </li>
                                        <li
                                            class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                                            <span><i class="bi bi-book me-2"></i>Mata Pelajaran</span>
                                            <span class="fw-bold">{{ seting_soal.Mapel }}</span>
                                        </li>
                                        <li
                                            class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                                            <span><i class="bi bi-people me-2"></i>Kelas</span>
                                            <span class="fw-bold">{{ seting_soal.Kelas }}</span>
                                        </li>
                                        <li
                                            class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                                            <span><i class="bi bi-key me-2"></i>Kode Ujian</span>
                                            <span class="fw-bold">{{ seting_soal.Kode_Soal }}</span>
                                        </li>
                                    </ul>

                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="card question-card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Soal Nomor {{ current_soal.Nomor }}
                        </h5>
                        <span class="badge bg-light text-primary">Soal {{ current_soal.Nomor }} dari {{ total_soal}}</span>
                    </div>
                    <div class="card-body">
                        <form method="post">
                        {% csrf_token %}

                        {# ================== TAMPILAN SOAL ================== #}
                        {% if not is_finish_page %}

                        <div class="card mb-3">
                            <div class="card-body">

                                <h5 class="mb-3">
                                    Soal Nomor {{ current_soal.Nomor }} dari {{ total_soal }}
                                </h5>

                                <table class="table table-borderless align-middle">
                                    <tbody>
                                        <tr>
                                            <td colspan="3" class="pb-4">
                                                {{ current_soal.Soal|safe }}
                                            </td>
                                        </tr>

                                        {% for opsi in "ABCD" %}
                                        <tr>
                                            <td width="40">
                                                <input class="form-check-input" type="radio"
                                                    name="jawaban" value="{{ opsi }}"
                                                    data-soal-id="{{ current_soal.id }}"
                                                    {% if jawaban.Jawaban == opsi %}checked{% endif %}>
                                            </td>
                                            <td width="30"><strong>{{ opsi }}.</strong></td>
                                            <td>
                                                {{ current_soal|get_opsi:opsi|safe }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                            </div>
                        </div>

                        {% endif %}

                        {# ================== HALAMAN FINISH ================== #}
                        {% if is_finish_page %}

                        <div class="card text-center">
                            <div class="card-body">

                                <h4 class="mb-3">
                                    <i class="bi bi-clipboard-check"></i> Konfirmasi Penyelesaian Ujian
                                </h4>

                                <p>
                                    Anda telah mengerjakan
                                    <strong>{{ jawaban_count }}</strong> dari
                                    <strong>{{ total_soal }}</strong> soal
                                </p>

                                {% if semua_terjawab %}
                                    <div class="alert alert-success">
                                        Semua soal telah dijawab. Silakan klik simpan & selesai atau Cek lagi.
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning">
                                        Masih ada soal yang belum dijawab.
                                        Silakan klik <strong>Cek Lagi</strong>.
                                    </div>
                                {% endif %}

                            </div>
                        </div>

                        {% endif %}

                        {# ================== TOMBOL NAVIGASI ================== #}
                        <div class="d-flex justify-content-between mt-4">

                            {# === SEBELUMNYA === #}
                            {% if not is_finish_page and current_soal.Nomor > 1 %}
                                <button type="submit" name="prev" class="btn btn-secondary px-4">
                                    <i class="fas fa-arrow-left me-2"></i>Sebelumnya
                                </button>
                            {% else %}
                                <div></div>
                            {% endif %}

                            {# === KANAN === #}
                            {% if not is_finish_page %}
                                <button type="submit" name="next" class="btn btn-primary px-4">
                                    Selanjutnya <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            {% else %}
                                <div class="d-flex justify-content-between gap-3 container-fluid">
                                    {% if semua_terjawab %}
                                        <button type="submit" name="finish_exam"
                                                class="btn btn-success " id="btnSelesai">
                                            <i class="bi bi-check-circle "></i>
                                            Simpan & Selesai
                                        </button>
                                    {% else %}
                                        <button class="btn btn-danger " disabled>
                                            <i class="bi bi-x-circle "></i>
                                            Simpan & Selesai
                                        </button>
                                    {% endif %}

                                    <a href="?nomor={{ total_soal }}"
                                    class="btn btn-warning ">
                                        <i class="bi bi-arrow-counterclockwise "></i>
                                        Cek Lagi
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include "setting/js-2.html" %}
    {% include "setting/js.html" %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ======================
            // KONSTANTA & STATE GLOBAL
            // ======================
            const AUTOSAVE_INTERVAL = 10000;
            const BATCH_SIZE = 5;
            const kodeSoal = "{{ seting_soal.Kode_Soal }}";
            const csrfToken = "{{ csrf_token }}";
            
            // State variables
            let jawabanCache = {};
            let jawabanDikirim = {};
            let pendingChanges = new Set();
            let remainingSeconds = {{ total_detik }};
            let timerInterval;
            let autosaveInterval;
            let isExamFinished = false;
            let isSubmitting = false;
            let isNavigatingInternally = false; // FLAG BARU

            // ======================
            // 1. FUNGSI TIMER (TETAP SAMA)
            // ======================
            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return [
                    hours.toString().padStart(2, '0'),
                    minutes.toString().padStart(2, '0'),
                    secs.toString().padStart(2, '0')
                ].join(':');
            }

            function updateTimerDisplay(seconds) {
                const timeString = formatTime(seconds);
                const timerElement = document.getElementById('timer');
                const mobileTimerElement = document.getElementById('mobile-timer');
                
                if (timerElement) timerElement.textContent = timeString;
                if (mobileTimerElement) mobileTimerElement.textContent = timeString;

                if (seconds < 300) {
                    const elements = [timerElement, mobileTimerElement].filter(el => el);
                    elements.forEach(el => el.classList.add('text-danger', 'fw-bold'));
                    if (seconds === 60) showAlert('Waktu tersisa 1 menit!');
                }
            }

            function showAlert(message) {
                const existingAlert = document.querySelector('.alert[role="alert"]');
                if (existingAlert) existingAlert.remove();

                const alertHtml = `
                    <div class="position-fixed top-0 start-0 w-100 alert alert-danger alert-dismissible fade show" role="alert" style="z-index: 9999">
                        <strong>Peringatan!</strong> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.body.insertAdjacentHTML('afterbegin', alertHtml);
                
                setTimeout(() => {
                    const alert = document.querySelector('.alert[role="alert"]');
                    if (alert) alert.remove();
                }, 5000);
            }

            // ======================
            // 2. SISTEM CACHE JAWABAN
            // ======================
            function simpanKeCache(soalId, jawaban) {
                if (jawabanDikirim[soalId] === jawaban) {
                    pendingChanges.delete(soalId);
                    delete jawabanCache[soalId];
                    return false;
                }
                
                jawabanCache[soalId] = jawaban;
                pendingChanges.add(soalId);
                
                // Auto-save langsung untuk jawaban saat ini (opsional)
                // Tapi tetap di cache untuk batch processing nanti
                return true;
            }

            function kirimBatchKeServer() {
                if (isSubmitting || isExamFinished || pendingChanges.size === 0) {
                    return;
                }

                const batchToSend = {};
                let count = 0;
                
                for (const soalId of pendingChanges) {
                    if (count >= BATCH_SIZE) break;
                    if (jawabanCache[soalId]) {
                        batchToSend[soalId] = jawabanCache[soalId];
                        count++;
                    }
                }

                if (Object.keys(batchToSend).length === 0) return;

                isSubmitting = true;
                
                fetch("{% url 'cbt:submit_batch_jawaban' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({
                        kode_soal: kodeSoal,
                        jawaban: batchToSend
                    })
                })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        Object.keys(batchToSend).forEach(soalId => {
                            jawabanDikirim[soalId] = batchToSend[soalId];
                            pendingChanges.delete(soalId);
                            delete jawabanCache[soalId];
                        });
                    }
                })
                .catch(error => {
                    console.error('Batch send error:', error);
                })
                .finally(() => {
                    isSubmitting = false;
                });
            }

            // ======================
            // 3. SUBMIT SEMUA SEKALIGUS
            // ======================
            function submitSemuaJawaban() {
                return new Promise((resolve, reject) => {
                    if (isSubmitting) {
                        resolve(false);
                        return;
                    }

                    isSubmitting = true;

                    const semuaJawaban = {};
                    
                    document.querySelectorAll('input[name="jawaban"]').forEach(el => {
                        if (el.checked) {
                            const soalId = el.dataset.soalId;
                            semuaJawaban[soalId] = el.value;
                            simpanKeCache(soalId, el.value);
                        }
                    });

                    Object.keys(jawabanCache).forEach(soalId => {
                        if (!semuaJawaban[soalId]) {
                            semuaJawaban[soalId] = jawabanCache[soalId];
                        }
                    });

                    if (Object.keys(semuaJawaban).length === 0) {
                        isSubmitting = false;
                        resolve(true);
                        return;
                    }

                    fetch("{% url 'cbt:submit_semua_jawaban' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken
                        },
                        body: JSON.stringify({
                            kode_soal: kodeSoal,
                            jawaban: semuaJawaban
                        })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'ok') {
                            jawabanCache = {};
                            jawabanDikirim = {};
                            pendingChanges.clear();
                            resolve(true);
                        } else {
                            reject(data.message || 'Gagal menyimpan');
                        }
                    })
                    .catch(error => {
                        console.error('Submit semua error:', error);
                        reject(error);
                    })
                    .finally(() => {
                        isSubmitting = false;
                    });
                });
            }

            // ======================
            // 4. HANDLE WAKTU HABIS
            // ======================
            function handleTimeExpired() {
                if (isExamFinished) return;
                isExamFinished = true;

                clearInterval(timerInterval);
                clearInterval(autosaveInterval);
                updateTimerDisplay(0);

                isNavigatingInternally = true; // Tandai sebagai navigasi internal
                
                submitSemuaJawaban()
                    .then(() => {
                        window.location.href = "{% url 'cbt:selesai_ujian' kode_soal=seting_soal.Kode_Soal %}";
                    })
                    .catch(() => {
                        window.location.href = "{% url 'cbt:selesai_ujian' kode_soal=seting_soal.Kode_Soal %}";
                    });
            }

            // ======================
            // 5. INISIALISASI SISTEM
            // ======================
            function initExamSystem() {
                // Timer
                updateTimerDisplay(remainingSeconds);
                
                timerInterval = setInterval(() => {
                    remainingSeconds--;
                    updateTimerDisplay(remainingSeconds);
                    if (remainingSeconds <= 0) handleTimeExpired();
                }, 1000);

                // Autosave Batch
                autosaveInterval = setInterval(() => {
                    if (pendingChanges.size > 0) {
                        kirimBatchKeServer();
                    }
                }, AUTOSAVE_INTERVAL);

                // Event listener untuk jawaban
                document.querySelectorAll('input[name="jawaban"]').forEach(el => {
                    el.addEventListener('change', () => {
                        const soalId = el.dataset.soalId;
                        const jawaban = el.value;
                        simpanKeCache(soalId, jawaban);
                    });
                });

                // ==============================================
                // PERBAIKAN: Handle form submit untuk navigasi
                // ==============================================
                const examForm = document.querySelector('form[method="post"]');
                if (examForm) {
                    examForm.addEventListener('submit', function(e) {
                        // Tandai sebagai navigasi internal saat submit form
                        isNavigatingInternally = true;
                        
                        // Simpan jawaban yang aktif sebelum navigasi
                        const activeAnswer = document.querySelector('input[name="jawaban"]:checked');
                        if (activeAnswer) {
                            const soalId = activeAnswer.dataset.soalId;
                            const jawaban = activeAnswer.value;
                            simpanKeCache(soalId, jawaban);
                            
                            // Kirim langsung jawaban aktif ini (tidak perlu tunggu batch)
                            // Ini opsional, bisa dihapus jika ingin tetap pakai batch saja
                            fetch("{% url 'cbt:autosave_jawaban' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded",
                                    "X-CSRFToken": csrfToken
                                },
                                body: new URLSearchParams({
                                    soal_id: soalId,
                                    kode_soal: kodeSoal,
                                    jawaban: jawaban
                                })
                            }).catch(() => {
                                // Biarkan di cache jika gagal
                                console.log('Autosave gagal, jawaban tetap di cache');
                            });
                        }
                        
                        // Biarkan form submit berjalan normal
                        return true;
                    });
                }

                // ==============================================
                // PERBAIKAN: Beforeunload handler yang SMART
                // ==============================================
                window.addEventListener('beforeunload', (e) => {
                    // Jangan tampilkan peringatan jika:
                    // 1. Sedang navigasi internal (submit form)
                    // 2. Ujian sudah selesai
                    // 3. Tidak ada perubahan yang pending
                    if (isNavigatingInternally || isExamFinished || pendingChanges.size === 0) {
                        return;
                    }
                    
                    if (!isExamFinished && remainingSeconds > 0 && pendingChanges.size > 0) {
                        e.preventDefault();
                        e.returnValue = 'Ada jawaban yang belum disimpan. Yakin ingin meninggalkan halaman?';
                        return e.returnValue;
                    }
                });

                // ==============================================
                // PERBAIKAN: Handle link navigasi soal (untuk mobile/desktop)
                // ==============================================
                document.querySelectorAll('a.nav-btn').forEach(link => {
                    link.addEventListener('click', function(e) {
                        // Tandai sebagai navigasi internal
                        isNavigatingInternally = true;
                        
                        // Simpan jawaban yang aktif sebelum navigasi
                        const activeAnswer = document.querySelector('input[name="jawaban"]:checked');
                        if (activeAnswer) {
                            const soalId = activeAnswer.dataset.soalId;
                            const jawaban = activeAnswer.value;
                            simpanKeCache(soalId, jawaban);
                            
                            // Kirim langsung sebelum navigasi
                            fetch("{% url 'cbt:autosave_jawaban' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded",
                                    "X-CSRFToken": csrfToken
                                },
                                body: new URLSearchParams({
                                    soal_id: soalId,
                                    kode_soal: kodeSoal,
                                    jawaban: jawaban
                                })
                            }).catch(() => {
                                console.log('Autosave gagal saat klik navigasi');
                            });
                        }
                        
                        // Biarkan link berjalan normal
                        return true;
                    });
                });

                // Tombol selesai
                const finishBtn = document.getElementById('btnSelesai');
                if (finishBtn) {
                    finishBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        const totalSoal = {{ total_soal }};
                        const jawabanCount = {{ jawaban_count }};
                        const semuaTerjawab = {{ semua_terjawab|yesno:"true,false" }};
                        
                        if (!semuaTerjawab) {
                            const belumTerjawab = totalSoal - jawabanCount;
                            if (!confirm(`Masih ada ${belumTerjawab} soal yang belum dijawab.\nYakin ingin menyelesaikan ujian?`)) {
                                return;
                            }
                        } else {
                            if (!confirm('Yakin ingin menyelesaikan ujian?')) {
                                return;
                            }
                        }

                        clearInterval(autosaveInterval);
                        clearInterval(timerInterval);
                        
                        // Tandai sebagai navigasi internal
                        isNavigatingInternally = true;
                        
                        const originalHtml = finishBtn.innerHTML;
                        finishBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
                        finishBtn.disabled = true;

                        submitSemuaJawaban()
                            .then(() => {
                                window.location.href = "{% url 'cbt:selesai_ujian' kode_soal=seting_soal.Kode_Soal %}";
                            })
                            .catch((error) => {
                                console.error('Finish error:', error);
                                alert('Gagal menyimpan jawaban. Coba lagi!');
                                finishBtn.innerHTML = originalHtml;
                                finishBtn.disabled = false;
                                isNavigatingInternally = false; // Reset flag
                            });
                    });
                }
            }

            // ======================
            // 6. MULAI SISTEM
            // ======================
            initExamSystem();

        });
    </script>
</body>

</html>